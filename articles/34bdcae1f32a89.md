---
title: "Lambda@Edgeã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’GitHub Actionsã§è‡ªå‹•åŒ–ã™ã‚‹"
emoji: "ğŸš€"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["GitHubActions", "AWS", "Lambda", "CloudFront"]
published: true
---
ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã¯ç°¡å˜ã«å®Ÿæ–½ã§ãã‚‹Lambdaï¼ Edgeã®ãƒ‡ãƒ—ãƒ­ã‚¤ã§ã™ãŒã€CLIã§è‡ªå‹•åŒ–ã™ã‚‹ã®ã¯ã‚„ã‚„é¢å€’ã§ã™ã€‚æœ¬è¨˜äº‹ã§ã¯GitHub Actionsã‹ã‚‰Lambda@Edgeã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹Workflowã‚’ç´¹ä»‹ã—ã¾ã™ã€‚ã”å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

# èƒŒæ™¯
ä»Šå›ç´¹ä»‹ã™ã‚‹Workflowã¯ä»¥ä¸‹ã®èƒŒæ™¯ã‹ã‚‰ä½œæˆã—ã¾ã—ãŸã€‚

- IaCã§ä½œæˆãƒ»ç®¡ç†ã•ã‚Œã¦ã„ãªã„Lambdaé–¢æ•°ãŒã‚ã‚‹ã€‚ã“ã®Lambdaé–¢æ•°ã‚’æ›´æ–°ã—ã¦ã€Lambda@Edgeã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹é‹ç”¨ä½œæ¥­ã‚’çœåŠ›åŒ–ã—ãŸã„ã€‚
- ã“ã®Lambdaé–¢æ•°ã¯ã‚¤ãƒ³ãƒ•ãƒ©ã‚’æ‹…å½“ã™ã‚‹ãƒãƒ¼ãƒ ï¼ˆSREï¼‰ã ã‘ã§ãªãã€ã‚µãƒ¼ãƒ“ã‚¹é–‹ç™ºãƒãƒ¼ãƒ ãŒæ›´æ–°ã™ã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚æ›´æ–°ä½œæ¥­ã¯SREãŒå¼•ãå—ã‘ã‚‹ã®ã§ã¯ãªãã€é–‹ç™ºãƒãƒ¼ãƒ ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿæ–½ã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã€ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ ãŒé•·ããªã‚‹ã“ã¨ã‚’é¿ã‘ãŸã„ã€‚
- é–‹ç™ºãƒãƒ¼ãƒ ã«ã¯AWSã«è©³ã—ããªã„ãƒ¡ãƒ³ãƒãƒ¼ã‚‚ã„ã‚‹ã€‚ãã®ãŸã‚ã€é–‹ç™ºè€…ã«IAMæ¨©é™ã‚’ç§»è­²ã—ã¦AWSã®ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚„APIã‹ã‚‰ãƒªã‚½ãƒ¼ã‚¹ã‚’æ“ä½œã—ã¦ã‚‚ã‚‰ã†ã®ã§ã¯ãªãã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦ã‚‚ã‚‰ã†æ–¹æ³•ã§ä½œæ¥­ã‚’å®Ÿæ–½ã—ã¦ã‚‚ã‚‰ã„ãŸã„ã€‚

ã“ã†ã„ã£ãŸèƒŒæ™¯ã‹ã‚‰ã€GitHub Actionsã‚’é€šã—ã¦Lambda@Edgeã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦ã‚‚ã‚‰ã†ã“ã¨ã«ã—ã¾ã—ãŸã€‚ã“ã®æ–¹æ³•ã«ã¯æ¬¡ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã—ãŸã€‚

- é–‹ç™ºè€…ãŒAWS CLIã®å®Ÿè¡Œç’°å¢ƒã‚’æº–å‚™ã™ã‚‹å¿…è¦ãŒãªã„ã€‚
- é–‹ç™ºè€…ç”¨IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ–°è¦ä½œæˆã€æ—¢å­˜IAMãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®æ¨©é™è¿½åŠ ã‚’è¡Œã†å¿…è¦ãŒãªã„ã€‚GitHub Actionsç”¨ã®IAMãƒ­ãƒ¼ãƒ«ã‚’æº–å‚™ã™ã‚Œã°ã‚ˆãã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®è¦³ç‚¹ã§å¥½ã¾ã—ã„ã€‚

# ã‚¤ãƒ¡ãƒ¼ã‚¸
![](/images/34bdcae1f32a89/lambda-deploy-from-gha.png)

# è¨­è¨ˆ
ä»Šå›ç´¹ä»‹ã™ã‚‹Workflowã®è¨­è¨ˆã¯æ¬¡ã®ã¨ãŠã‚Šã§ã™ã€‚

- Workflowã¯äºŒã¤ã«åˆ†ã‘ã‚‹ã€‚
  - Lambdaé–¢æ•°ã‚’æ›´æ–°ã™ã‚‹Workflow
  - Lambdaé–¢æ•°ã‚’Lambda@Edgeã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹Workflowï¼ˆCloudFront distributionã‚’æ›´æ–°ã™ã‚‹Workflowï¼‰
- Workflowã¯æ‰‹å‹•ã§å®Ÿè¡Œã—ã¦ã‚‚ã‚‰ã†ã€‚

## Workflowã‚’äºŒã¤ã«åˆ†ã‘ã‚‹ç†ç”±
å®‰å…¨æ€§ã‚’è€ƒæ…®ã—ã¦åˆ†ã‘ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚åˆ¥ã€…ã«ã—ã¦ãŠãã¨æ¬¡ã®ãƒ¡ãƒªãƒƒãƒˆãŒã‚ã‚Šã¾ã™ã€‚
- åˆ¥ã€…ã«åˆ‡ã‚Šæˆ»ã›ã‚‹ã“ã¨
- Lambdaé–¢æ•°ã®æ›´æ–°ç›´å¾Œã«ã‚³ãƒ¼ãƒ‰ã®å•é¡ŒãŒç™ºè¦šã—ãŸã¨ãã€Workflowã‚’åˆ†ã‘ã¦ãŠã‘ã°ã€å•é¡Œã®ã‚ã‚‹ã‚³ãƒ¼ãƒ‰ãŒãã®ã¾ã¾Lambda@Edgeã¸ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã“ã¨ã‚’é˜²ã’ã‚‹ã“ã¨

## Workflowã‚’æ‰‹å‹•ã§å®Ÿè¡Œã—ã¦ã‚‚ã‚‰ã†ç†ç”±
`workflow_dispatch`é™å®šã®Workflowã«ã—ã¾ã—ãŸã€‚å¤§ã—ãŸãƒ¡ãƒªãƒƒãƒˆã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆï¼ˆã‚¹ã‚¤ãƒƒãƒï¼‰ã™ã‚‹æ‰‹é–“ãŒçœã‘ã¾ã™ã€‚

# Workflow
```yml:update-lambda-function.yml
name: Update lambda function

on:
  workflow_dispatch:
      inputs:
        environment:
          description: 'Deployment environment'
          required: true
          type: choice
          options:
          - develop
          - staging
          - production

jobs:
  deploy-lambda:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1

    steps:
      - uses: actions/checkout@v3

      - name: Set constants for develop
        if: ${{ inputs.environment == 'develop' }}
        run: |
          echo "AWS_ROLE_ARN=aws:iam::your-aws-account-number:role/your-iam-role-arn-name" >> $GITHUB_ENV
          echo "AWS_LAMBDA_FUNCTION_ARN=arn:aws:lambda:us-east-1:your-aws-account-number:function:your-lambda-function-name" >> $GITHUB_ENV

      - name: Set constants for staging
        if: ${{ inputs.environment == 'staging' }}
        run: |
          echo "AWS_ROLE_ARN=aws:iam::your-aws-account-number:role/your-iam-role-arn-name" >> $GITHUB_ENV
          echo "AWS_LAMBDA_FUNCTION_ARN=arn:aws:lambda:us-east-1:your-aws-account-number:function:your-lambda-function-name" >> $GITHUB_ENV

      - name: Set constants for production
        if: ${{ inputs.environment == 'production' }}
        run: |
          echo "AWS_ROLE_ARN=aws:iam::your-aws-account-number:role/your-iam-role-arn-name" >> $GITHUB_ENV
          echo "AWS_LAMBDA_FUNCTION_ARN=arn:aws:lambda:us-east-1:your-aws-account-number:function:your-lambda-function-name" >> $GITHUB_ENV

      - name: Configure aws credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Zip function code
        run: zip your-function-code.zip your-function-code

      - name: Update function code
        run: aws lambda update-function-code --function-name ${{ env.AWS_LAMBDA_FUNCTION_ARN }} --zip-file fileb://your-function-code.zip

      - name: Wait for update-function-code completion
        timeout-minutes: 10
        run: |
          while :; \
          do \
          LAMBDA_UPDATE_STATUS=$(aws lambda get-function --function-name ${{ env.AWS_LAMBDA_FUNCTION_ARN }} | jq -r .Configuration.LastUpdateStatus); \
          LAMBDA_STATE=$(aws lambda get-function --function-name ${{ env.AWS_LAMBDA_FUNCTION_ARN }} | jq -r .Configuration.State); \
            if [ "$LAMBDA_UPDATE_STATUS" = "Successful" ] && [ "$LAMBDA_STATE" = "Active" ]; \
            then \
              echo "update completion"; \
              break; \
            elif [ "$LAMBDA_UPDATE_STATUS" = "InProgress" ] || [ "$LAMBDA_STATE" = "Pending" ]; \
            then \
              echo "update inprogress"; \
              sleep 5; \
            else \
              echo "update failed"; \
              exit 1; \
            fi; \
          done

      - name: Publish version
        run: aws lambda publish-version --function-name ${{ env.AWS_LAMBDA_FUNCTION_ARN }}
```

```yml:deploy-lambda-fuction-to-lambda@edge.yml
name: Deploy lambda function to Lambda@Edge

on:
  workflow_dispatch:
      inputs:
        environment:
          description: 'Deployment environment'
          required: true
          type: choice
          options:
          - develop
          - staging
          - production

jobs:
  update-distribution:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      AWS_REGION: us-east-1

    steps:
      - uses: actions/checkout@v3

      - name: Set constants for develop
        if: ${{ inputs.environment == 'develop' }}
        run: |
          echo "AWS_ROLE_ARN=aws:iam::your-aws-account-number:role/your-iam-role-arn-name" >> $GITHUB_ENV
          echo "AWS_LAMBDA_FUNCTION_ARN=arn:aws:lambda:us-east-1:your-aws-account-number:function:your-lambda-function-name" >> $GITHUB_ENV
          echo "AWS_CLOUDFRONT_DISTRIBUTION_ID=your-cloudfront-distribution-id" >> $GITHUB_ENV

      - name: Set constants for staging
        if: ${{ inputs.environment == 'staging' }}
        run: |
          echo "AWS_ROLE_ARN=aws:iam::your-aws-account-number:role/your-iam-role-arn-name" >> $GITHUB_ENV
          echo "AWS_LAMBDA_FUNCTION_ARN=arn:aws:lambda:us-east-1:your-aws-account-number:function:your-lambda-function-name" >> $GITHUB_ENV
          echo "AWS_CLOUDFRONT_DISTRIBUTION_ID=your-cloudfront-distribution-id" >> $GITHUB_ENV

      - name: Set constants for production
        if: ${{ inputs.environment == 'production' }}
        run: |
          echo "AWS_ROLE_ARN=aws:iam::your-aws-account-number:role/your-iam-role-arn-name" >> $GITHUB_ENV
          echo "AWS_LAMBDA_FUNCTION_ARN=arn:aws:lambda:us-east-1:your-aws-account-number:function:your-lambda-function-name" >> $GITHUB_ENV
          echo "AWS_CLOUDFRONT_DISTRIBUTION_ID=your-cloudfront-distribution-id" >> $GITHUB_ENV

      - name: Configure aws credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Set variables
        run: |
          echo CURRENT_CONFIG=$(aws cloudfront get-distribution-config --id ${{ env.AWS_CLOUDFRONT_DISTRIBUTION_ID }} | jq '.DistributionConfig') >> $GITHUB_ENV
          echo ETAG=$(aws cloudfront get-distribution-config --id ${{ env.AWS_CLOUDFRONT_DISTRIBUTION_ID }} | jq -r '.ETag') >> $GITHUB_ENV
          echo VERSION=$(aws lambda list-versions-by-function --function-name ${{ env.AWS_LAMBDA_FUNCTION_ARN }} | jq -r '.Versions[-1].Version') >> $GITHUB_ENV

      - name: Make config for updating
        run: echo '${{ env.CURRENT_CONFIG }}' | jq "(.DefaultCacheBehavior.LambdaFunctionAssociations.Items[] | select(.EventType == \"origin-request\") | .LambdaFunctionARN) |= \"${{ env.AWS_LAMBDA_FUNCTION_ARN }}:${{ env.VERSION }}\"" > config.json

      - name: Update distribution
        run: aws cloudfront update-distribution --id ${{ env.AWS_CLOUDFRONT_DISTRIBUTION_ID }} --distribution-config file://config.json --if-match ${{ env.ETAG }}
      
      - name: Wait for update-distribution completion
        timeout-minutes: 20
        run: |
          while :; \
          do STATUS=$(aws cloudfront get-distribution --id ${{ env.AWS_CLOUDFRONT_DISTRIBUTION_ID }} | jq -r .Distribution.Status); \
            if [ "$STATUS" = "InProgress" ]; \
            then \
              echo "update inprogress"; \
              sleep 10; \
            else \
              echo "update completion"; \
              break; \
            fi; \
          done
```
## ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ç’°å¢ƒã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
Workflowå®Ÿè¡Œã™ã‚‹å‰ã«ã€ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆã®ç’°å¢ƒã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¨ã—ã¦å—ã‘å–ã‚‹ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚
`workflow_dispatch`>`inputs`>`environment`ã®ç®‡æ‰€ãŒè©²å½“ã—ã¾ã™ã€‚
`inputs`ã«ã¤ã„ã¦ã¯[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.github.com/ja/actions/using-workflows/events-that-trigger-workflows#workflow_dispatch)ã‚’ã”å‚ç…§ãã ã•ã„ã€‚

`inputs`ã§å—ã‘å–ã£ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã¯`${{ inputs.environment }}`ã¨ã„ã†å½¢å¼ã§å‚ç…§ã—ã¾ã™ã€‚
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã®å€¤ã«å¿œã˜ã¦GitHub ActionsãŒå¼•ãå—ã‘ã‚‹IAMãƒ­ãƒ¼ãƒ«ã€æ›´æ–°ã™ã‚‹Lambdaé–¢æ•°ã€ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹Lambda@Edgeï¼ˆCloudFront distributionï¼‰ã®ä¸‰ã¤ã‚’åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚ä¸‰ã¤ã®å€¤ã¯ç’°å¢ƒå¤‰æ•°[`$GITHUB_ENV`](https://docs.github.com/ja/actions/using-workflows/workflow-commands-for-github-actions#setting-an-environment-variable)ã«æ›¸ãè¾¼ã‚“ã§ãŠãã€å¾Œç¶šã®stepã«ãŠã„ã¦`echo ${{ env.key }}`ã§å‚ç…§ã—ã¾ã™ã€‚

## stepã‚’è·¨ã„ã§å¤‰æ•°ã‚’å¼•ãç¶™ã
stepã‚’è·¨ã„ã§çµæœã‚’å…±æœ‰ã™ã‚‹ã«ã¯ã€æœ¬è¨˜äº‹ã®ã‚ˆã†ã«ç’°å¢ƒå¤‰æ•°`$GITHUB_ENV`ã«æ›¸ãè¾¼ã‚€ã‹ã€[set-output](https://docs.github.com/ja/actions/using-workflows/workflow-commands-for-github-actions#setting-an-output-parameter)ã‚’ä½¿ç”¨ã—ã¦åˆ¥stepã‹ã‚‰å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
stepã”ã¨ã«ã‚·ã‚§ãƒ«ãŒä¸ãˆã‚‰ã‚Œã‚‹ãŸã‚`key=value`ã®ã‚ˆã†ã«ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã‚·ã‚§ãƒ«å¤‰æ•°ã‚’å®šç¾©ã—ã¦ã‚‚ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ãã®ã‚·ã‚§ãƒ«å¤‰æ•°ã¯å‚ç…§ã§ãã¾ã›ã‚“ã€‚

## å¤‰æ•°ã«ä»£å…¥ã™ã‚‹ã€å‚ç…§ã™ã‚‹
é€šå¸¸ã€ä»£å…¥ã¯`echo "key=value" >> $GITHUB_ENV`ã§è¡Œã„ã¾ã™ã€‚valueãŒæ”¹è¡Œã‚’å«ã¾ãªã„å ´åˆã¯ã“ã®æ›¸ãæ–¹ã§å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
æ”¹è¡Œã‚’å«ã‚€å ´åˆã€æ”¹è¡Œã‚ã‚Šã®å€¤ã‚’å‚ç…§ã™ã‚‹ã«ã¯[è¤‡æ•°è¡Œã®æ–‡å­—åˆ—ã‚’æ‰±ã†æ›¸ãæ–¹](https://docs.github.com/ja/actions/using-workflows/workflow-commands-for-github-actions#multiline-strings)ã«å¾“ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ã¯ã€ä»¥ä¸‹ã®ç®‡æ‰€ã§ã¯æ„å›³çš„ã«`echo key=value >> $GITHUB_ENV`ã¨æ›¸ã„ã¦ã„ã¾ã™ã€‚
```yml
- name: Set variables
  run: |
    echo CURRENT_CONFIG=$(aws cloudfront get-distribution-config --id ${{ env.AWS_CLOUDFRONT_DISTRIBUTION_ID }} | jq '.DistributionConfig') >> $GITHUB_ENV
    echo ETAG=$(aws cloudfront get-distribution-config --id ${{ env.AWS_CLOUDFRONT_DISTRIBUTION_ID }} | jq -r '.ETag') >> $GITHUB_ENV
    echo VERSION=$(aws lambda list-versions-by-function --function-name ${{ env.AWS_LAMBDA_FUNCTION_ARN }} | jq -r '.Versions[-1].Version') >> $GITHUB_ENV
```
CURRENT_CONFIGã®å€¤ã¯CloudFront distributionã®è¨­å®šã§ã™ãŒã€`echo "key=value" >> $GITHUB_ENV`ã¨æ›¸ãã¨æ”¹è¡Œã‚’å«ã‚€JSONã‚’ä»£å…¥ã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã™ã€‚
```
Error: Unable to process file command 'env' successfully.
Error: Invalid environment variable format '  "CallerReference": "",'
```
æ”¹è¡Œã‚’å«ã‚€å ´åˆã¯å‰è¿°ã®è¤‡æ•°è¡Œã®æ–‡å­—åˆ—ã‚’æ‰±ã†æ›¸ãæ–¹ã«å¾“ã‚ãªã„ã¨ã„ã‘ã¾ã›ã‚“ã€‚ã—ã‹ã—ã€CloudFrontã®update-distributionã‚³ãƒãƒ³ãƒ‰ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«æ¸¡ã™JSONãƒ•ã‚¡ã‚¤ãƒ«ã¯æ”¹è¡ŒãŒãªãã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ã®ã§ã€ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å›²ã‚ãšã«ã‚ãˆã¦`echo key=value >> $GITHUB_ENV`ã¨æ›¸ã„ã¦ã„ã¾ã™ã€‚ãã®ãŸã‚CURRENT_CONFIGã«ã¯ä¸€è¡Œã®é•·ã„JSONãŒå…¥ã£ã¦ã„ã¾ã™ã€‚

ETAGã¨VERSIONã®ç’°å¢ƒå¤‰æ•°ã‚’ã‚»ãƒƒãƒˆã™ã‚‹è¡Œã¯`"key=value"`ã¨æ›¸ã„ã¦ã‚‚ã€`key=value`ã¨æ›¸ã„ã¦ã‚‚Workflowã®å‹•ä½œã«å½±éŸ¿ã—ãªã„ãŸã‚ã€CURRENT_CONFIGã«æ›¸ãæ–¹ã‚’åˆã‚ã›ã¦ã„ã¾ã™ã€‚ï¼ˆå¾Œã«ãªã£ã¦CURRENT_CONFIGã®è¡Œã«ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ›¸ãå¿˜ã‚Œã¦ã„ã‚‹ã¨æ€ã„é•ã„ã‚’ã—ãªã„ã‚ˆã†ã«ã™ã‚‹ãŸã‚ï¼‰

CURRENT_CONFIGã®å€¤ã‚’å‚ç…§ã™ã‚‹ã¨ãã«ã€`echo '${{ env.CURRENT_CONFIG }}'`ã¨ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã£ã¦ã„ã‚‹ã®ã«ã¯ç†ç”±ãŒã‚ã‚Šã€ã‚·ãƒ³ã‚°ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚ãªã„ã¨JSONã‹ã‚‰ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ¶ˆãˆã¦ã—ã¾ã„ã€ãƒ‘ã‚¤ãƒ—ã§ç¹‹ã„ã jqã‚³ãƒãƒ³ãƒ‰ãŒãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã™ã€‚

## æ›´æ–°å®Œäº†ã‚’å¾…æ©Ÿã™ã‚‹
Lambdaé–¢æ•°ã®æ›´æ–°å®Œäº†ã‚’å¾…æ©Ÿã™ã‚‹Wait for update-function-code completionã¯å¿…é ˆã‚¹ãƒ†ãƒƒãƒ—ã§ã™ã€‚Lambdaé–¢æ•°ã«ã¯çŠ¶æ…‹ã®æ¦‚å¿µãŒã‚ã‚Šã€é–¢æ•°ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç™ºè¡ŒãŒå¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
[é–¢æ•°ã®çŠ¶æ…‹](https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/functions-states.html)
[AWS Lambdaé–¢æ•°ã®çŠ¶æ…‹ã¨è¿½è·¡](https://aws.amazon.com/jp/blogs/news/tracking-the-state-of-lambda-functions/)

CloudFront distributionã®æ›´æ–°å®Œäº†ã‚’å¾…æ©Ÿã™ã‚‹Wait for update-distribution completionã¯å¿…é ˆã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ã‚ã£ãŸæ–¹ãŒã‚ˆã„ã§ã—ã‚‡ã†ã€‚CloudFront distributionã®æ›´æ–°ã«ã¯5åˆ†å¼±ã¯ã‹ã‹ã‚Šã¾ã™ã€‚é–‹ç™ºè€…ã«ã¯æ›´æ–°ãŒæ­£å¸¸ã«å®Œäº†ã—ãŸã‹çŸ¥ã£ã¦ã‚‚ã‚‰ã†å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚„APIã‹ã‚‰CloudFront distributionã®çŠ¶æ…‹ã‚’ç¢ºèªã•ã›ãŸããªã„ã®ã§ã€distributionã®æ›´æ–°ãŒæ­£å¸¸ã«å®Œäº†ã—ãŸã“ã¨ã‚’ã‚‚ã£ã¦Workflowã‚’æ­£å¸¸çµ‚äº†ã•ã›ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚

ãªãŠã€æ›´æ–°ã®stepã«ã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã—ã¦ã„ã¾ã™ã€‚ã“ã®è¨­å®šã¯ã€AWSå´ã§ä½•ã‚‰ã‹ã®å•é¡ŒãŒç™ºç”Ÿã—ã¦çŠ¶æ…‹ãŒç•°å¸¸ã§ã‚ã‚‹ã«ã‚‚é–¢ã‚ã‚‰ãšã€ActionsãŒstepã®å®Œäº†ã‚’å¾…æ©Ÿã—ã¦åˆ©ç”¨å¯èƒ½æ ã‚’æµªè²»ã™ã‚‹ã“ã¨ã‚’é¿ã‘ã‚‹ãŸã‚ã§ã™ã€‚ä»¥ä¸‹ã‚’å‚è€ƒã«ã€å¿µã®ãŸã‚ã«è¨­å®šã—ã¾ã—ãŸã€‚
https://dev.classmethod.jp/articles/must-set-timeout-on-actions-for-save-cost/

# IAM
GitHub ActionsãŒå¼•ãå—ã‘ã‚‹IAM Roleã«å‰²ã‚Šå½“ã¦ã‚‹æœ€å°æ¨©é™ã®IAM Policyã¯ä»¥ä¸‹ã«ãªã‚Šã¾ã—ãŸã€‚
```json:policy
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "DeployLambda",
            "Effect": "Allow",
            "Action": [
                "lambda:UpdateFunctionCode",
                "lambda:PublishVersion",
                "lambda:ListVersionsByFunction",
                "lambda:GetFunction",
                "lambda:GetFunctionConfiguration",
                "lambda:EnableReplication*"
            ],
            "Resource": [
                "arn:aws:lambda:us-east-1:your-aws-account-number:function:your-lambda-function-arn",
                "arn:aws:lambda:us-east-1:your-aws-account-number:function:your-lambda-function-arn:*"
            ]
        },
        {
            "Sid": "UpdateDistribution",
            "Effect": "Allow",
            "Action": [
                "cloudfront:GetDistribution",
                "cloudfront:GetDistributionConfig",
                "cloudFront:UpdateDistribution"
            ],
            "Resource": "arn:aws:cloudfront::your-aws-account:distribution/your-cloudfront-distribution-id"
        }
    ]
}
```
IAM Roleã®ä¿¡é ¼é–¢ä¿‚ã«ã¯ä»¥ä¸‹ã‚’è¨˜è¼‰ã—ã¾ã—ãŸã€‚
```json:trust relationship
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Principal": {
                "Federated": "arn:aws:iam::your-aws-account-numberber:oidc-provider/token.actions.githubusercontent.com"
            },
            "Action": "sts:AssumeRoleWithWebIdentity",
            "Condition": {
                "StringLike": {
                    "token.actions.githubusercontent.com:sub": "repo:your-organization-name/your-repository-name:*"
                }
            }
        }
    ]
}
```
# ã‚ã¨ãŒã
ä»Šå›ã€ã¯ã˜ã‚ã¦GitHub Actionsã®Workflowã‚’è‡ªä½œã—ã¾ã—ãŸãŒã€å‰²ã¨ã™ã‚“ãªã‚Šä½œæˆã§ãã¾ã—ãŸã€‚update-distrbution ã«æ¸¡ã™JSONã®ä½œæˆã§ãƒãƒã‚Šã¾ã—ãŸã€‚æœ€å°æ¨©é™ã®IAMãƒãƒªã‚·ãƒ¼ã‚’æ›¸ãã®ã‚‚ã‚„ã£ã±ã‚Šå°‘ã—æ‰‹é–“ã§ã—ãŸã€‚ğŸ¦­